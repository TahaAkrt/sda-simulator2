<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SDA — Uzay Alan Farkındalığı Simülatörü</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@200;400;600;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #020508;
    --bg2: #040d16;
    --panel: rgba(4, 18, 32, 0.85);
    --border: rgba(0, 200, 255, 0.18);
    --cyan: #00c8ff;
    --cyan2: #00ffe7;
    --orange: #ff6b35;
    --yellow: #ffe066;
    --green: #39ff7a;
    --red: #ff3a5c;
    --text: #c8e8f8;
    --dim: #4a7a9b;
    --glow: 0 0 24px rgba(0,200,255,0.35);
    --glow2: 0 0 32px rgba(0,255,231,0.25);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── STARFIELD ── */
  #starfield {
    position: fixed; inset: 0; z-index: 0;
    overflow: hidden; pointer-events: none;
  }
  .star {
    position: absolute; border-radius: 50%;
    background: white; animation: twinkle var(--dur,3s) infinite alternate;
  }
  @keyframes twinkle { from{opacity:.1} to{opacity:.9} }

  /* ── GRID OVERLAY ── */
  body::before {
    content:''; position:fixed; inset:0; z-index:1; pointer-events:none;
    background-image:
      linear-gradient(rgba(0,200,255,.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,200,255,.03) 1px, transparent 1px);
    background-size: 48px 48px;
  }

  /* ── LAYOUT ── */
  #app { position:relative; z-index:2; }

  /* ── HEADER ── */
  header {
    padding: 32px 48px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 24px;
    background: linear-gradient(180deg, rgba(0,200,255,.06) 0%, transparent 100%);
  }
  .logo-icon {
    width:52px; height:52px; flex-shrink:0;
    animation: spin 18s linear infinite;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  header h1 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(1.1rem,2.5vw,1.9rem);
    font-weight: 900;
    letter-spacing:.15em;
    background: linear-gradient(90deg, var(--cyan), var(--cyan2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-shadow: none;
    filter: drop-shadow(0 0 12px var(--cyan));
  }
  header p {
    font-family:'Share Tech Mono'; font-size:.78rem;
    color:var(--dim); letter-spacing:.1em; margin-top:4px;
  }
  .badge {
    margin-left:auto; font-family:'Orbitron'; font-size:.65rem;
    padding:6px 14px; border:1px solid var(--cyan);
    color:var(--cyan); border-radius:4px;
    box-shadow: var(--glow); letter-spacing:.15em;
    animation: pulse 2.4s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100%{box-shadow:0 0 10px rgba(0,200,255,.3)}
    50%{box-shadow:0 0 30px rgba(0,200,255,.7)}
  }

  /* ── NAV TABS ── */
  nav {
    display:flex; gap:0;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    overflow-x: auto;
  }
  nav button {
    font-family:'Orbitron'; font-size:.7rem; letter-spacing:.12em;
    padding:14px 28px; background:none; border:none; border-bottom:2px solid transparent;
    color:var(--dim); cursor:pointer; transition:all .25s; white-space:nowrap;
  }
  nav button:hover { color:var(--cyan); }
  nav button.active {
    color:var(--cyan); border-bottom-color:var(--cyan);
    background: rgba(0,200,255,.06);
    text-shadow: 0 0 12px var(--cyan);
  }

  /* ── SECTIONS ── */
  .section { display:none; padding:32px 24px 48px; max-width:1400px; margin:0 auto; }
  .section.active { display:block; animation: fadeIn .35s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* ── PANELS ── */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius:8px; padding:24px;
    backdrop-filter: blur(8px);
  }
  .panel-title {
    font-family:'Orbitron'; font-size:.78rem; letter-spacing:.18em;
    color:var(--cyan); margin-bottom:20px;
    padding-bottom:10px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:10px;
  }
  .panel-title::before {
    content:''; display:block; width:8px; height:8px;
    border:2px solid var(--cyan); border-radius:50%;
    box-shadow: 0 0 8px var(--cyan);
  }

  /* ── GRID LAYOUTS ── */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
  .grid-3-1 { display:grid; grid-template-columns:2fr 1fr; gap:20px; }
  @media(max-width:900px) {
    .grid-2,.grid-3,.grid-3-1 { grid-template-columns:1fr; }
  }

  /* ── FORM INPUTS ── */
  .form-group { margin-bottom:16px; }
  label {
    display:block; font-family:'Share Tech Mono'; font-size:.72rem;
    color:var(--dim); margin-bottom:6px; letter-spacing:.08em;
  }
  input[type=number], input[type=range], select {
    width:100%; background: rgba(0,200,255,.05);
    border:1px solid var(--border); border-radius:4px;
    padding:8px 12px; color:var(--text); font-family:'Share Tech Mono'; font-size:.85rem;
    outline:none; transition:border-color .2s;
  }
  input[type=number]:focus, select:focus { border-color:var(--cyan); box-shadow:var(--glow); }
  input[type=range] {
    padding:4px 0; appearance:none; height:4px;
    background:rgba(0,200,255,.15); cursor:pointer; border:none; border-radius:2px;
  }
  input[type=range]::-webkit-slider-thumb {
    appearance:none; width:14px; height:14px; border-radius:50%;
    background:var(--cyan); box-shadow:0 0 8px var(--cyan);
  }
  .range-val {
    font-family:'Share Tech Mono'; font-size:.75rem; color:var(--cyan);
    text-align:right; margin-top:4px;
  }

  /* ── BUTTONS ── */
  .btn {
    font-family:'Orbitron'; font-size:.72rem; letter-spacing:.14em;
    padding:12px 28px; border:1px solid var(--cyan); border-radius:4px;
    background:rgba(0,200,255,.08); color:var(--cyan); cursor:pointer;
    transition:all .2s; width:100%;
  }
  .btn:hover {
    background:rgba(0,200,255,.2); box-shadow:var(--glow);
    transform:translateY(-2px);
  }
  .btn-orange {
    border-color:var(--orange); color:var(--orange); background:rgba(255,107,53,.08);
  }
  .btn-orange:hover { background:rgba(255,107,53,.2); box-shadow:0 0 24px rgba(255,107,53,.4); }
  .btn-green {
    border-color:var(--green); color:var(--green); background:rgba(57,255,122,.08);
  }
  .btn-green:hover { background:rgba(57,255,122,.2); box-shadow:0 0 24px rgba(57,255,122,.4); }

  /* ── DATA DISPLAY ── */
  .data-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 0; border-bottom:1px solid rgba(0,200,255,.06);
    font-family:'Share Tech Mono'; font-size:.82rem;
  }
  .data-row:last-child { border-bottom:none; }
  .data-key { color:var(--dim); }
  .data-val { color:var(--cyan2); font-weight:600; }
  .data-val.error { color:var(--orange); }
  .data-val.good { color:var(--green); }

  /* ── CANVAS ── */
  canvas {
    width:100%; border-radius:6px; display:block;
    background: rgba(0,8,16,.6);
    border:1px solid var(--border);
  }

  /* ── TABLE ── */
  .data-table {
    width:100%; border-collapse:collapse; font-family:'Share Tech Mono'; font-size:.78rem;
  }
  .data-table th {
    color:var(--cyan); padding:10px 12px; text-align:left;
    border-bottom:1px solid var(--border); font-family:'Orbitron'; font-size:.65rem;
    letter-spacing:.1em;
  }
  .data-table td {
    padding:9px 12px; border-bottom:1px solid rgba(0,200,255,.05);
    color:var(--text);
  }
  .data-table tr:hover td { background:rgba(0,200,255,.04); }

  /* ── STATUS ── */
  .status-dot {
    width:8px; height:8px; border-radius:50%; display:inline-block;
    margin-right:8px;
    animation: blink 1.2s step-end infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
  .dot-green { background:var(--green); box-shadow:0 0 8px var(--green); }
  .dot-orange { background:var(--orange); box-shadow:0 0 8px var(--orange); animation:none; }
  .dot-red { background:var(--red); box-shadow:0 0 8px var(--red); }

  /* ── METRICS CARD ── */
  .metric-card {
    background:rgba(0,200,255,.04); border:1px solid var(--border);
    border-radius:6px; padding:18px; text-align:center;
  }
  .metric-big {
    font-family:'Orbitron'; font-size:1.8rem; font-weight:700;
    color:var(--cyan2); margin:8px 0 4px;
    text-shadow: 0 0 20px var(--cyan2);
  }
  .metric-unit { font-family:'Share Tech Mono'; font-size:.72rem; color:var(--dim); }
  .metric-label { font-family:'Orbitron'; font-size:.6rem; letter-spacing:.15em; color:var(--dim); }

  /* ── PROGRESS ── */
  .progress-bar {
    height:6px; background:rgba(0,200,255,.12); border-radius:3px; overflow:hidden;
    margin-top:6px;
  }
  .progress-fill {
    height:100%; border-radius:3px; transition:width .4s ease;
    background:linear-gradient(90deg, var(--cyan), var(--cyan2));
    box-shadow: 0 0 10px var(--cyan);
  }

  /* ── LOG ── */
  #log {
    font-family:'Share Tech Mono'; font-size:.73rem; line-height:1.9;
    color:#4a7a9b; height:180px; overflow-y:auto;
    background:rgba(0,0,0,.4); border-radius:4px; padding:12px;
    border:1px solid var(--border);
  }
  #log .log-ok { color:var(--green); }
  #log .log-warn { color:var(--yellow); }
  #log .log-err { color:var(--red); }
  #log .log-info { color:var(--cyan); }

  /* ── SECTION HEADINGS ── */
  .sec-title {
    font-family:'Orbitron'; font-size:1rem; font-weight:700;
    color:var(--cyan); letter-spacing:.18em;
    margin-bottom:24px; padding-bottom:12px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
  }
  .sec-num {
    font-size:.65rem; background:var(--cyan); color:#000;
    border-radius:3px; padding:2px 8px; letter-spacing:0;
  }

  /* ── ORBIT VIZ ── */
  #orbitCanvas { height:420px; }
  #trackerCanvas { height:280px; }
  #errorCanvas { height:240px; }

  /* ── ABOUT CARD ── */
  .about-card {
    background:linear-gradient(135deg, rgba(0,200,255,.06), rgba(0,255,231,.03));
    border:1px solid var(--border); border-radius:8px; padding:28px;
  }
  .about-card h3 { font-family:'Orbitron'; color:var(--cyan); margin-bottom:12px; font-size:.9rem; }
  .about-card p { font-size:.88rem; line-height:1.75; color:var(--text); opacity:.85; margin-bottom:12px; }
  .eq-box {
    background:rgba(0,0,0,.5); border-left:3px solid var(--cyan);
    padding:14px 20px; border-radius:0 4px 4px 0; margin:16px 0;
    font-family:'Share Tech Mono'; font-size:.82rem; color:var(--cyan2); line-height:2.2;
  }

  /* scrollbar */
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:rgba(0,200,255,.04); }
  ::-webkit-scrollbar-thumb { background:rgba(0,200,255,.25); border-radius:3px; }

  .sep { width:100%; height:1px; background:var(--border); margin:20px 0; }

  .chip {
    display:inline-block; font-family:'Share Tech Mono'; font-size:.68rem;
    padding:3px 10px; border-radius:12px; margin:3px;
    border:1px solid; letter-spacing:.06em;
  }
  .chip-cyan { border-color:var(--cyan); color:var(--cyan); }
  .chip-orange { border-color:var(--orange); color:var(--orange); }
  .chip-green { border-color:var(--green); color:var(--green); }

  /* ── AUTHOR STRIP ── */
  #author-strip {
    position:fixed; bottom:0; left:0; right:0; z-index:100;
    background: linear-gradient(90deg, rgba(2,5,8,.97) 0%, rgba(4,18,32,.97) 50%, rgba(2,5,8,.97) 100%);
    border-top:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 28px; gap:20px;
    backdrop-filter:blur(12px);
  }
  .author-left { display:flex; align-items:center; gap:14px; }
  .author-avatar {
    width:34px; height:34px; border-radius:50%;
    background: linear-gradient(135deg, #00c8ff22, #00ffe722);
    border:1px solid var(--cyan); display:flex; align-items:center; justify-content:center;
    font-family:'Orbitron'; font-size:.75rem; color:var(--cyan); font-weight:700;
    box-shadow: 0 0 12px rgba(0,200,255,.3);
    flex-shrink:0;
  }
  .author-info { line-height:1.4; }
  .author-name {
    font-family:'Orbitron'; font-size:.75rem; font-weight:700;
    color:var(--cyan2); letter-spacing:.12em;
  }
  .author-role {
    font-family:'Share Tech Mono'; font-size:.65rem; color:var(--dim);
  }
  .author-center {
    font-family:'Share Tech Mono'; font-size:.68rem; color:var(--dim);
    letter-spacing:.08em; text-align:center;
  }
  .author-center span { color:var(--cyan); }

  /* QR Modal */
  #qr-btn {
    font-family:'Orbitron'; font-size:.65rem; letter-spacing:.12em;
    padding:7px 16px; border:1px solid var(--cyan); border-radius:4px;
    background:rgba(0,200,255,.08); color:var(--cyan); cursor:pointer;
    transition:all .2s; flex-shrink:0;
    display:flex; align-items:center; gap:8px;
  }
  #qr-btn:hover { background:rgba(0,200,255,.2); box-shadow:var(--glow); }
  #qr-btn svg { width:16px; height:16px; }

  #qr-modal {
    display:none; position:fixed; inset:0; z-index:200;
    background:rgba(0,0,0,.7); backdrop-filter:blur(6px);
    align-items:center; justify-content:center;
  }
  #qr-modal.open { display:flex; }
  .qr-card {
    background: var(--bg2); border:1px solid var(--border);
    border-radius:12px; padding:32px; text-align:center;
    animation: fadeIn .25s ease;
    max-width:340px; width:90%;
    box-shadow: 0 0 60px rgba(0,200,255,.15);
  }
  .qr-card h3 { font-family:'Orbitron'; color:var(--cyan); margin-bottom:6px; font-size:.85rem; letter-spacing:.15em; }
  .qr-card p { font-family:'Share Tech Mono'; font-size:.72rem; color:var(--dim); margin-bottom:20px; }
  #qr-canvas-wrap {
    background:#fff; border-radius:8px; padding:14px; display:inline-block;
    box-shadow: 0 0 24px rgba(0,200,255,.25);
  }
  #qrCanvas { display:block; }
  .qr-url {
    margin-top:16px; font-family:'Share Tech Mono'; font-size:.68rem;
    color:var(--cyan2); word-break:break-all;
    background:rgba(0,200,255,.06); padding:8px 12px; border-radius:4px;
    border:1px solid var(--border);
  }
  .qr-close {
    margin-top:16px; font-family:'Orbitron'; font-size:.65rem;
    padding:8px 24px; border:1px solid var(--dim); border-radius:4px;
    background:none; color:var(--dim); cursor:pointer;
    letter-spacing:.1em; transition:all .2s;
  }
  .qr-close:hover { border-color:var(--red); color:var(--red); }

  body { padding-bottom:58px; }

</style>
<script>
/* qrcode.js — MIT License — davidshimjs */
var QRCode;!function(){function a(a){this.mode=c.MODE_8BIT_BYTE,this.data=a,this.parsedData=[];for(var b=[],d=0,e=this.data.length;e>d;d++){var f=this.data.charCodeAt(d);if(f>65536?(b[0]=240|(1835008&f)>>>18,b[1]=128|(258048&f)>>>12,b[2]=128|(4032&f)>>>6,b[3]=128|63&f):f>2048?(b[0]=224|(61440&f)>>>12,b[1]=128|(4032&f)>>>6,b[2]=128|63&f):f>128?(b[0]=192|(1984&f)>>>6,b[1]=128|63&f):b[0]=f,this.parsedData=this.parsedData.concat(b),b=[]);}this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function b(a,b){this.typeNumber=a,this.errorCorrectLevel=b,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function i(a,b){if(void 0==a.length)throw new Error(a.length);for(var c=0,d=0;d<a.length;d++)c+=b(a[d]);return c}function j(a){for(var b=0;a>1;)a>>>=1,b++;return b}function k(a,b){for(var c=a,d=j(b)+j(a),e=new Array(d+1),f=d;f>=0;f--)e[f]=0;for(var g=j(a),f=g;f>=0;f--){if(0!=(c&1<<f))for(var h=j(b),i=h;i>=0;i--)e[f+i]^=b<<f-g+i-h}return e}function l(){var a=1335170093,b=1335170093;b=b>>16;a=65535&a;var c=Math.floor(a/b),d=a%b,e=32768-d,f=c*(e-b)+d*Math.floor(32768/b);return f=32768&f?f>>15:f>>15,f=1335170093-1335170093*f,f<0?f+2147483648:f}a.prototype={getLength:function(){return this.parsedData.length},write:function(a){for(var b=0,c=this.parsedData.length;c>b;b++)a.put(this.parsedData[b],8)}};b.prototype={addData:function(a){var c=new a(a);this.dataList.push(c),this.dataCache=null},isDark:function(a,b){if(0>a||this.moduleCount<=a||0>b||this.moduleCount<=b)throw new Error(a+","+b);return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,c){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++){this.modules[d]=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[d][e]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(a,c),this.typeNumber>=7&&this.setupTypeNumber(a),null==this.dataCache&&(this.dataCache=b.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,c)},setupPositionProbePattern:function(a,b){for(var c=-1;7>=c;c++)if(!(-1>=a+c||this.moduleCount<=a+c))for(var d=-1;7>=d;d++)-1>=b+d||this.moduleCount<=b+d||(this.modules[a+c][b+d]=c>=0&&6>=c&&(0==d||6==d)||d>=0&&6>=d&&(0==c||6==c)||c>=2&&4>=c&&d>=2&&4>=d?!0:!1)},getBestMaskPattern:function(){for(var a=0,b=0,c=0;8>c;c++){this.makeImpl(!0,c);var d=f.getLostPoint(this);(0==c||a>d)&&(a=d,b=c)}return b},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[6][a]&&(this.modules[6][a]=0==a%2);for(var b=8;b<this.moduleCount-8;b++)null==this.modules[b][6]&&(this.modules[b][6]=0==b%2)},setupPositionAdjustPattern:function(){for(var a=f.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var c=0;c<a.length;c++){var d=a[b],e=a[c];if(null==this.modules[d][e]){for(var g=-2;2>=g;g++)for(var h=-2;2>=h;h++)this.modules[d+g][e+h]=-2==g||2==g||-2==h||2==h||0==g&&0==h?!0:!1}}},setupTypeNumber:function(a){for(var b=f.getBCHTypeNumber(this.typeNumber),c=0;18>c;c++){var d=!a&&1==(b>>c&1);this.modules[Math.floor(c/3)][c%3+this.moduleCount-8-3]=d}for(var c=0;18>c;c++){var d=!a&&1==(b>>c&1);this.modules[c%3+this.moduleCount-8-3][Math.floor(c/3)]=d}},setupTypeInfo:function(a,b){for(var c=this.errorCorrectLevel<<3|b,d=f.getBCHTypeInfo(c),e=0;15>e;e++){var g=!a&&1==(d>>e&1);6>e?this.modules[e][8]=g:8>e?this.modules[e+1][8]=g:this.modules[this.moduleCount-15+e][8]=g}for(var e=0;15>e;e++){var g=!a&&1==(d>>e&1);8>e?this.modules[8][this.moduleCount-e-1]=g:9>e?this.modules[8][15-e-1+1]=g:this.modules[8][15-e-1]=g}this.modules[this.moduleCount-8][8]=!a},mapData:function(a,b){for(var c=-1,d=this.moduleCount-1,e=7,g=0,h=this.moduleCount-1;h>0;h-=2)for(6==h&&h--;;){for(var i=0;2>i;i++)if(null==this.modules[d][h-i]){var j=!1;g<a.length&&(j=1==(a[g]>>>e&1)),f.getMask(b,d,h-i)&&(j=!j),this.modules[d][h-i]=j,e--,-1==e&&(g++,e=7)}if(d+=c,0>d||this.moduleCount<=d){d-=c,c=-c;break}}}};b.PAD0=236,b.PAD1=17,b.createData=function(a,c,d){for(var e=g.getRSBlocks(a,c),h=new f.BitBuffer,i=0;i<d.length;i++){var j=d[i];h.put(j.mode,4),h.put(j.getLength(),f.getLengthInBits(j.mode,a)),j.write(h)}for(var k=0,i=0;i<e.length;i++)k+=e[i].dataCount;if(h.getLengthInBits()>8*k)throw new Error("code length overflow. ("+h.getLengthInBits()+">"+8*k+")");for(h.getLengthInBits()+4<=8*k&&h.put(0,4);0!=h.getLengthInBits()%8;)h.putBit(!1);for(;;){if(h.getLengthInBits()>=8*k)break;if(h.put(b.PAD0,8),h.getLengthInBits()>=8*k)break;h.put(b.PAD1,8)}return b.createBytes(h,e)},b.createBytes=function(a,b){for(var c=0,d=0,e=0,h=new Array(b.length),i=new Array(b.length),j=0;j<b.length;j++){var k=b[j].dataCount,l=b[j].totalCount-k;d=Math.max(d,k),e=Math.max(e,l),h[j]=new Array(k);for(var m=0;m<h[j].length;m++)h[j][m]=255&a.buffer[c++];i[j]=new Array(l);for(var m=0;m<i[j].length;m++)i[j][m]=0}for(var n=new Array(b.length),o=0,j=0;j<b.length;j++){var p=f.getErrorCorrectPolynomial(i[j].length),q=new f.Polynomial(h[j],p.getLength()-1),r=q.mod(p);i[j]=new Array(p.getLength()-1);for(var m=0;m<i[j].length;m++){var s=m+r.getLength()-i[j].length;i[j][m]=s>=0?r.get(s):0}}var t=0;for(var m=0;m<b.length;m++)t+=b[m].totalCount;var u=new Array(t),v=0;for(var m=0;m<d;m++)for(var j=0;j<b.length;j++)m<h[j].length&&(u[v++]=h[j][m]);for(var m=0;m<e;m++)for(var j=0;j<b.length;j++)m<i[j].length&&(u[v++]=i[j][m]);return u};var c={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},f=function(){var a=function(a,b){var c=0;for(b=b||[],a=a||[];a.length;)b.push(a.shift()%256);return c},b={};return b.getBCHTypeInfo=function(a){for(var b=a<<10;j(b)-j(1335)>=0;)b^=1335<<j(b)-j(1335);return 21522^(a<<10|b)},b.getBCHTypeNumber=function(a){for(var b=a<<12;j(b)-j(7973)>=0;)b^=7973<<j(b)-j(7973);return a<<12|b},b.getPatternPosition=function(a){return e[a-1]},b.getMask=function(a,b,c){switch(a){case 0:return 0==(b+c)%2;case 1:return 0==b%2;case 2:return 0==c%3;case 3:return 0==(b+c)%3;case 4:return 0==(Math.floor(b/2)+Math.floor(c/3))%2;case 5:return 0==b*c%2+b*c%3;case 6:return 0==(b*c%2+b*c%3)%2;case 7:return 0==(b*c%3+(b+c)%2)%2;default:throw new Error("bad maskPattern:"+a)}},b.getErrorCorrectPolynomial=function(a){for(var b=new f.Polynomial([1],0),c=0;a>c;c++)b=b.multiply(new f.Polynomial([1,h.gexp(c)],0));return b},b.getLengthInBits=function(a,b){if(b>=1&&10>b)switch(a){case c.MODE_NUMBER:return 10;case c.MODE_ALPHA_NUM:return 9;case c.MODE_8BIT_BYTE:return 8;case c.MODE_KANJI:return 8;default:throw new Error("mode:"+a)}else if(27>b)switch(a){case c.MODE_NUMBER:return 12;case c.MODE_ALPHA_NUM:return 11;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 10;default:throw new Error("mode:"+a)}else{if(!(40>=b))throw new Error("type:"+b);switch(a){case c.MODE_NUMBER:return 14;case c.MODE_ALPHA_NUM:return 13;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 12;default:throw new Error("mode:"+a)}}},b.getLostPoint=function(a){for(var b=a.getModuleCount(),c=0,d=0;b>d;d++)for(var e=0;b>e;e++){for(var g=0,h=a.isDark(d,e),i=-1;1>=i;i++)if(!(0>d+i||b<=d+i))for(var j=-1;1>=j;j++)0>e+j||b<=e+j||(-1==i&&-1==j||(h==a.isDark(d+i,e+j)&&g++));g>5&&(c+=3+g-5)}for(var d=0;b-1>d;d++)for(var e=0;b-1>e;e++){var k=0;a.isDark(d,e)&&k++,a.isDark(d+1,e)&&k++,a.isDark(d,e+1)&&k++,a.isDark(d+1,e+1)&&k++,(0==k||4==k)&&(c+=3)}for(var d=0;b>d;d++)for(var e=0;b-6>e;e++)a.isDark(d,e)&&!a.isDark(d,e+1)&&a.isDark(d,e+2)&&a.isDark(d,e+3)&&a.isDark(d,e+4)&&!a.isDark(d,e+5)&&a.isDark(d,e+6)&&(c+=40);for(var e=0;b>e;e++)for(var d=0;b-6>d;d++)a.isDark(d,e)&&!a.isDark(d+1,e)&&a.isDark(d+2,e)&&a.isDark(d+3,e)&&a.isDark(d+4,e)&&!a.isDark(d+5,e)&&a.isDark(d+6,e)&&(c+=40);for(var l=0,d=0;b>d;d++)for(var e=0;b>e;e++)a.isDark(d,e)&&l++;var m=Math.abs(100*l/b/b-50)/5;return c+=10*m},b.BitBuffer=function(){this.buffer=[],this.length=0},b.BitBuffer.prototype={get:function(a){return 1==(this.buffer[Math.floor(a/8)]>>>7-a%8&1)},put:function(a,b){for(var c=0;b>c;c++)this.putBit(1==(a>>>b-c-1&1))},getLengthInBits:function(){return this.length},putBit:function(a){var b=Math.floor(this.length/8);this.buffer.length<=b&&this.buffer.push(0),a&&(this.buffer[b]|=128>>>this.length%8),this.length++}},b.Polynomial=function(a,b){if(void 0==a.length)throw new Error(a.length);var c=0;for(;a.length>c&&0==a[c];)c++;this.num=new Array(a.length-c+(b||0));for(var d=0;d<a.length-c;d++)this.num[d]=a[d+c]},b.Polynomial.prototype={get:function(a){return this.num[a]},getLength:function(){return this.num.length},multiply:function(a){for(var b=new Array(this.getLength()+a.getLength()-1),c=0;c<this.getLength();c++)for(var d=0;d<a.getLength();d++)b[c+d]^=h.gexp(h.glog(this.get(c))+h.glog(a.get(d)));return new f.Polynomial(b,0)},mod:function(a){if(this.getLength()-a.getLength()<0)return this;var b=h.glog(this.get(0))-h.glog(a.get(0));for(var c=new Array(this.getLength()),d=0;d<this.getLength();d++)c[d]=this.get(d);for(var d=0;d<a.getLength();d++)c[d]^=h.gexp(h.glog(a.get(d))+b);return new f.Polynomial(c,0).mod(a)}},b.getRSBlocks=function(a,b){var c=g.getRSBlockTable(a,b);if(void 0==c)throw new Error("bad rs block @ typeNumber:"+a+"/errorCorrectLevel:"+b);var d=c.length/3,e=[];for(var f=0;d>f;f++)for(var h=c[3*f+0],i=c[3*f+1],j=c[3*f+2],k=0;h>k;k++)e.push({totalCount:i,dataCount:j});return e},b.getRSBlockTable=function(a,b){switch(b){case m.L:return n[a-1][0];case m.M:return n[a-1][1];case m.Q:return n[a-1][2];case m.H:return n[a-1][3]}},b}(),e=[[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,132],[6,34,60,86,112,136],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],g={getRSBlocks:function(a,b){return f.getRSBlockTable(a,b)},getRSBlockTable:f.getRSBlockTable},h={glog:function(a){if(1>a)throw new Error("glog("+a+")");return o[a]},gexp:function(a){for(;0>a;)a+=255;for(;a>=256;)a-=255;return p[a]}},m={L:1,M:0,Q:3,H:2},n=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],o=new Array(256),p=new Array(256),q=function(){for(var a=1,b=0;255>b;b++)p[b]=a,o[a]=b,a<<=1,a>=256&&(a^=285);p[255]=p[0],o[0]=0}(),r=QRCode=function(a,b){if("string"==typeof b&&(b={text:b}),this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:2},b)for(var c in b)this._htOption[c]=b[c];"string"==typeof a&&(a=document.getElementById(a)),this._el=a,this._oQRCode=null,this._oDrawing=new s(a,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)};r.prototype.makeCode=function(a){this._oQRCode=new b(f.getTypeNumber(a,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(a),this._oQRCode.make(),this._el.title=a,this._oDrawing.draw(this._oQRCode),this.makeImage()},r.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&this._oDrawing.makeImage()},r.prototype.clear=function(){this._oDrawing.clear()},r.CorrectLevel={L:1,M:0,Q:3,H:2};var s=function(a,b){this._bIsPainted=!1,this._htOption=b;var c=this._elCanvas=document.createElement("canvas");c.width=b.width,c.height=b.height,a.appendChild(c),this._oContext=c.getContext("2d"),this._bIsPainted=!1,this._android=t()};s.prototype.draw=function(a){var b=this._htOption,c=this._oContext,d=a.getModuleCount();c.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),c.fillStyle=b.colorLight,c.fillRect(0,0,this._elCanvas.width,this._elCanvas.height),c.fillStyle=b.colorDark;var e=Math.floor(Math.min(b.width,b.height)/d);for(var f=0;d>f;f++)for(var g=0;d>g;g++)if(a.isDark(f,g)){var h=g*e,i=f*e;c.fillRect(h,i,e,e)}},s.prototype.makeImage=function(){},s.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},s.prototype.round=function(a){return a?Math.floor(1e3*a)/1e3:a};var t=function(){for(var a=navigator.appVersion,b=0,c=[/android/i],d=0;d<c.length;d++)a.search(c[d])!=-1&&(b=parseFloat(a.slice(a.search(c[d])+c[d].source.length)));return b};f.getTypeNumber=function(a,b){for(var c=b||2,d=1;40>=d;d++){var e=f.getRSBlocks(d,c),g=new f.BitBuffer,h=0;for(var i=0;i<e.length;i++)h+=e[i].dataCount;var j=new a(a);if(j.getLength()<=h)return d}throw new Error("No valid type number")};a.prototype.getLength=function(){return this.parsedData.length};a.prototype.write=function(a){for(var b=0,c=this.parsedData.length;c>b;b++)a.put(this.parsedData[b],8)};f.getTypeNumber=function(a,b){for(var c=1;40>=c;c++){var d=f.getRSBlocks(c,b),e=new f.BitBuffer,g=0;for(var h=0;h<d.length;h++)g+=d[h].dataCount;if(new QRCode._oDataList(a).getLength()<=g)return c}throw new Error("No valid type number")};QRCode._oDataList=a}();
</script>
</head>
<body>

<div id="starfield"></div>

<div id="app">

<!-- HEADER -->
<header>
  <svg class="logo-icon" viewBox="0 0 52 52" fill="none">
    <circle cx="26" cy="26" r="23" stroke="#00c8ff" stroke-width="1.5" opacity=".4"/>
    <ellipse cx="26" cy="26" rx="23" ry="9" stroke="#00ffe7" stroke-width="1" stroke-dasharray="4 3"/>
    <circle cx="26" cy="26" r="4" fill="#00c8ff" opacity=".9"/>
    <circle cx="43" cy="18" r="3" fill="#ff6b35"/>
    <circle cx="12" cy="36" r="3" fill="#39ff7a"/>
    <line x1="26" y1="26" x2="43" y2="18" stroke="#00c8ff" stroke-width="1" stroke-dasharray="3 2" opacity=".5"/>
    <line x1="26" y1="26" x2="12" y2="36" stroke="#00c8ff" stroke-width="1" stroke-dasharray="3 2" opacity=".5"/>
  </svg>
  <div>
    <h1>UZAY ALAN FARKINDALIK SİMÜLATÖRÜ</h1>
    <p>STAR TRACKER · GNSS · PARALLAX · RSO YÖRÜNGE BELİRLEME · IEEE TAES 2025</p>
  </div>
  <div class="badge">CANLI SİMÜLASYON</div>
</header>

<!-- NAV -->
<nav>
  <button class="active" onclick="showTab('sim')">⟁ SİMÜLASYON</button>
  <button onclick="showTab('parallax')">◈ PARALLAKS HESAP</button>
  <button onclick="showTab('orbit')">⊙ YÖRÜNGE ANALİZİ</button>
  <button onclick="showTab('sensitivity')">⚡ HASSASLIK ANALİZİ</button>
  <button onclick="showTab('about')">∑ MAKALE</button>
</nav>

<!-- ═══════════ TAB 1 — SİMÜLASYON ═══════════ -->
<div id="tab-sim" class="section active">
  <div class="sec-title"><span class="sec-num">01</span> UYDU FORMASYONU & RSO TAKİP SİMÜLASYONU</div>

  <div class="grid-3-1" style="margin-bottom:20px;">

    <!-- Main orbit canvas -->
    <div class="panel">
      <div class="panel-title">3D YÖRÜNGE GÖRSELLEŞTİRMESİ — ECI ÇERÇEVE</div>
      <canvas id="orbitCanvas"></canvas>
      <div style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap;">
        <span><span class="status-dot dot-green"></span><span style="font-family:'Share Tech Mono';font-size:.72rem;color:var(--green)">ST-1 Uydu</span></span>
        <span><span class="status-dot dot-orange" style="animation:none"></span><span style="font-family:'Share Tech Mono';font-size:.72rem;color:var(--orange)">ST-2 Uydu</span></span>
        <span><span class="status-dot" style="background:var(--cyan);box-shadow:0 0 8px var(--cyan);animation:none"></span><span style="font-family:'Share Tech Mono';font-size:.72rem;color:var(--cyan)">RSO Hedef</span></span>
        <span><span class="status-dot" style="background:var(--yellow);box-shadow:0 0 8px var(--yellow);animation:none"></span><span style="font-family:'Share Tech Mono';font-size:.72rem;color:var(--yellow)">Tahmin Konum</span></span>
      </div>
    </div>

    <!-- Controls -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <div class="panel">
        <div class="panel-title">PARAMETRE KONTROLÜ</div>
        <div class="form-group">
          <label>FORMASYON TABAN UZAKLIĞI (km)</label>
          <input type="range" id="baseline" min="5" max="50" value="20" oninput="updateSim()">
          <div class="range-val" id="baseline-val">20 km</div>
        </div>
        <div class="form-group">
          <label>RSO YÜKSEK İRTİFASI (km)</label>
          <input type="range" id="rsoAlt" min="600" max="1200" value="700" oninput="updateSim()">
          <div class="range-val" id="rsoAlt-val">700 km</div>
        </div>
        <div class="form-group">
          <label>CENTROID HATASI (piksel)</label>
          <input type="range" id="centroidErr" min="0.001" max="0.2" step="0.001" value="0.015" oninput="updateSim()">
          <div class="range-val" id="centroidErr-val">0.015 px</div>
        </div>
        <div class="form-group">
          <label>SİMÜLASYON HIZI</label>
          <input type="range" id="simSpeed" min="1" max="10" value="3" oninput="document.getElementById('simSpeed-val').textContent=this.value+'x'">
          <div class="range-val" id="simSpeed-val">3x</div>
        </div>
        <button class="btn btn-green" onclick="startSim()" id="simBtn">▶ SİMÜLASYONU BAŞLAT</button>
      </div>

      <div class="panel">
        <div class="panel-title">GERÇEK ZAMANLI METRIKLER</div>
        <div class="data-row"><span class="data-key">Konum Hatası</span><span class="data-val" id="posErr">— m</span></div>
        <div class="data-row"><span class="data-key">Eş Zamanlı Obs.</span><span class="data-val" id="simObs">0 / 160</span></div>
        <div class="data-row"><span class="data-key">FOV Örtüşme</span><span class="data-val" id="fovOverlap">—</span></div>
        <div class="data-row"><span class="data-key">α₁ (mesafe)</span><span class="data-val" id="alpha1">— km</span></div>
        <div class="data-row"><span class="data-key">α₂ (mesafe)</span><span class="data-val" id="alpha2">— km</span></div>
        <div class="data-row"><span class="data-key">Paralaks Açısı</span><span class="data-val" id="parallaxAngle">—</span></div>
        <div class="data-row"><span class="data-key">Sim Zamanı</span><span class="data-val" id="simTime">0.0 s</span></div>
      </div>
    </div>
  </div>

  <!-- Star tracker views + log -->
  <div class="grid-2">
    <div class="panel">
      <div class="panel-title">STAR TRACKER GÖRÜNTÜLERİ — AÇISAL KOORDİNATLAR</div>
      <canvas id="trackerCanvas"></canvas>
    </div>
    <div class="panel">
      <div class="panel-title">SİSTEM GÜNLÜĞÜ</div>
      <div id="log"><span class="log-info">[ SDA ] Sistem hazır. Simülasyonu başlatmak için butona basın.</span><br></div>
      <div class="sep"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:4px;">
        <div class="metric-card">
          <div class="metric-label">GNSS PPP</div>
          <div class="metric-big" style="font-size:1.1rem;">±100</div>
          <div class="metric-unit">mm abs.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">GNSS RTK</div>
          <div class="metric-big" style="font-size:1.1rem;">±10</div>
          <div class="metric-unit">mm rel.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">FOV</div>
          <div class="metric-big" style="font-size:1.1rem;">20°</div>
          <div class="metric-unit">× 20°</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ TAB 2 — PARALLAKS ═══════════ -->
<div id="tab-parallax" class="section">
  <div class="sec-title"><span class="sec-num">02</span> PARALLAKS TABANLI RSO KONUM HESAPLAMA</div>

  <div class="grid-2" style="margin-bottom:20px;">
    <div class="panel">
      <div class="panel-title">UYDU POZİSYONLARI (ECI — km)</div>
      <div class="form-group">
        <label>ST-1 X Konumu (km)</label>
        <input type="number" id="p1x" value="6978" step="1">
      </div>
      <div class="form-group">
        <label>ST-1 Y (B₁) (km)</label>
        <input type="number" id="p1y" value="9" step="0.5">
      </div>
      <div class="form-group">
        <label>ST-1 Z (B₃) (km)</label>
        <input type="number" id="p1z" value="0.5" step="0.1">
      </div>
      <div class="sep"></div>
      <div class="form-group">
        <label>ST-2 X Konumu (km)</label>
        <input type="number" id="p2x" value="6978" step="1">
      </div>
      <div class="form-group">
        <label>ST-2 Y (B₂) (km)</label>
        <input type="number" id="p2y" value="-11" step="0.5">
      </div>
      <div class="form-group">
        <label>ST-2 Z (-B₃) (km)</label>
        <input type="number" id="p2z" value="-0.5" step="0.1">
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">RSO HEDEF & BİRİM VEKTÖRLER</div>
      <div class="form-group">
        <label>Hedef X (km) — RSO</label>
        <input type="number" id="ptx" value="7078" step="1">
      </div>
      <div class="form-group">
        <label>Hedef Y (km)</label>
        <input type="number" id="pty" value="0" step="1">
      </div>
      <div class="form-group">
        <label>Hedef Z (km)</label>
        <input type="number" id="ptz" value="0" step="1">
      </div>
      <div class="sep"></div>
      <div class="form-group">
        <label>Centroid Hatası σ (piksel)</label>
        <input type="number" id="centErrCalc" value="0.015" step="0.001" min="0.001" max="0.5">
      </div>
      <div class="form-group">
        <label>Monte Carlo Örnekleme Sayısı</label>
        <input type="number" id="mcSamples" value="200" step="50" min="50" max="2000">
      </div>
      <button class="btn" onclick="calcParallax()" style="margin-bottom:10px;">◈ PARALLAKS HESAPLA</button>
      <button class="btn btn-orange" onclick="runMonteCarlo()">⟳ MONTE CARLO ANALİZİ</button>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-title">HESAPLAMA SONUÇLARI — Eq.(9)-(11)</div>
      <div id="parallaxResults">
        <div style="font-family:'Share Tech Mono';font-size:.78rem;color:var(--dim);text-align:center;padding:40px 0;">
          Parametreleri girin ve hesapla butonuna basın.
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">MONTE CARLO HATA DAĞILIMI</div>
      <canvas id="errorCanvas"></canvas>
      <div id="mcStats" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- ═══════════ TAB 3 — YÖRÜNGE ═══════════ -->
<div id="tab-orbit" class="section">
  <div class="sec-title"><span class="sec-num">03</span> RSO YÖRÜNGE BELİRLEME — ALGORİTMA 1</div>

  <div class="grid-3-1" style="margin-bottom:20px;">
    <div class="panel">
      <div class="panel-title">YÖRÜNGE BELİRLEME SONUÇLARI (GIBBS YÖNTEMİ)</div>
      <table class="data-table" id="orbitTable">
        <thead>
          <tr>
            <th>PARAMETRE</th>
            <th>SEMBOL</th>
            <th>GERÇEK DEĞER</th>
            <th>TAHMİN EDİLEN</th>
            <th>HATA</th>
          </tr>
        </thead>
        <tbody id="orbitTableBody"></tbody>
      </table>
      <div class="sep"></div>
      <button class="btn btn-green" onclick="runOrbitDet()" style="width:auto;display:inline-block;margin-right:10px;">⟳ YENİ SİMÜLASYON</button>
      <span id="orbitStatus" style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);"></span>
    </div>

    <div style="display:flex;flex-direction:column;gap:16px;">
      <div class="panel">
        <div class="panel-title">MAKALE TABLo II</div>
        <table class="data-table">
          <thead><tr><th></th><th>GERÇEK</th><th>HATA</th></tr></thead>
          <tbody>
            <tr><td>a (km)</td><td style="color:var(--cyan2)">7085.1</td><td style="color:var(--orange)">0.69 m</td></tr>
            <tr><td>e</td><td style="color:var(--cyan2)">0.00106</td><td style="color:var(--orange)">3.8×10⁻⁷</td></tr>
            <tr><td>i (°)</td><td style="color:var(--cyan2)">97.816°</td><td style="color:var(--orange)">2.6×10⁻⁶</td></tr>
            <tr><td>Ω (°)</td><td style="color:var(--cyan2)">0.573°</td><td style="color:var(--orange)">2.1×10⁻⁵</td></tr>
            <tr><td>ω (°)</td><td style="color:var(--cyan2)">90°</td><td style="color:var(--orange)">0.1348°</td></tr>
            <tr><td>λ(t₀) (°)</td><td style="color:var(--cyan2)">77.481°</td><td style="color:var(--green)">4.6×10⁻⁶</td></tr>
          </tbody>
        </table>
      </div>
      <div class="panel">
        <div class="panel-title">ALGORİTMA 1 ADIMLARI</div>
        <div id="algoSteps">
          <div class="data-row"><span style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);">1. RSO pozisyon çözümü (centroid)</span><span class="chip chip-green">✓</span></div>
          <div class="data-row"><span style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);">2. Polinom yörünge fiti (6. derece)</span><span class="chip chip-green">✓</span></div>
          <div class="data-row"><span style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);">3. Gibbs metodu için 3 nokta</span><span class="chip chip-green">✓</span></div>
          <div class="data-row"><span style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);">4. Gibbs yörünge belirleme</span><span class="chip chip-green">✓</span></div>
          <div class="data-row"><span style="font-family:'Share Tech Mono';font-size:.75rem;color:var(--dim);">5. Ortalama orbital elemanlar</span><span class="chip chip-green">✓</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">GÖZLEM ARKI — 160 EŞ ZAMANLI GÖZLEM (160 s)</div>
    <canvas id="obsArcCanvas" style="height:200px;"></canvas>
  </div>
</div>

<!-- ═══════════ TAB 4 — HASSASLIK ═══════════ -->
<div id="tab-sensitivity" class="section">
  <div class="sec-title"><span class="sec-num">04</span> HASSASLIK ANALİZİ — HATA KAYNAKLARI</div>

  <div class="grid-3" style="margin-bottom:20px;">
    <div class="metric-card">
      <div class="metric-label">CENTROID HATASI (0.1 px)</div>
      <div class="metric-big">~31</div>
      <div class="metric-unit">metre konum hatası</div>
      <div class="progress-bar"><div class="progress-fill" style="width:95%"></div></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">GNSS PPP ABS</div>
      <div class="metric-big">~150</div>
      <div class="metric-unit">mm pozisyon</div>
      <div class="progress-bar"><div class="progress-fill" style="width:15%;background:linear-gradient(90deg,var(--green),var(--cyan2))"></div></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">CENTROID (0.015 px)</div>
      <div class="metric-big">~3.0</div>
      <div class="metric-unit">metre konum hatası</div>
      <div class="progress-bar"><div class="progress-fill" style="width:30%;background:linear-gradient(90deg,var(--yellow),var(--orange))"></div></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-title">TABAN UZAKLIĞI vs KONUM HATASI</div>
      <canvas id="baselineCanvas" style="height:260px;"></canvas>
    </div>
    <div class="panel">
      <div class="panel-title">CENTROID HATASI vs RSO KONUM HATASI</div>
      <canvas id="centroidCanvas" style="height:260px;"></canvas>
    </div>
  </div>

  <div class="sep"></div>
  <div class="grid-2">
    <div class="panel">
      <div class="panel-title">POLİNOM FİT DOĞRULUK İYİLEŞTİRMESİ</div>
      <div class="about-card" style="padding:16px;">
        <p>160 eş zamanlı gözlemle, sıfır-ortalama bağımsız hatalar varsayımıyla:</p>
        <div class="eq-box">
          İyileştirme ≈ √160 > 12×
          <br>
          σ_fit = σ_single / √N_obs
          <br>
          σ_single = 3.0 m → σ_fit ≈ 0.24 m
        </div>
        <p>6. dereceden polinom yeterli; daha yüksek derece anlamlı fark yaratmamaktadır.</p>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">HATA KATKI DAĞILIMI</div>
      <canvas id="pieCanvas" style="height:220px;"></canvas>
    </div>
  </div>
</div>

<!-- ═══════════ TAB 5 — MAKALE ═══════════ -->
<div id="tab-about" class="section">
  <div class="sec-title"><span class="sec-num">05</span> MAKALE ÖZETİ — IEEE TAES 2025</div>

  <div class="grid-2">
    <div>
      <div class="about-card" style="margin-bottom:20px;">
        <h3>MAKALE BİLGİLERİ</h3>
        <div class="data-row"><span class="data-key">Başlık</span><span class="data-val" style="font-size:.75rem;text-align:right;max-width:55%;">Enhancing SDA Using Star Trackers in Satellite Formations</span></div>
        <div class="data-row"><span class="data-key">Dergi</span><span class="data-val">IEEE TAES, Vol.61 No.3</span></div>
        <div class="data-row"><span class="data-key">Yayın</span><span class="data-val">Haziran 2025</span></div>
        <div class="data-row"><span class="data-key">DOI</span><span class="data-val" style="font-size:.72rem;">10.1109/TAES.2025.3528922</span></div>
        <div style="margin-top:14px;">
          <span class="chip chip-cyan">Thangavel</span>
          <span class="chip chip-cyan">Burroni</span>
          <span class="chip chip-cyan">Servidia</span>
          <span class="chip chip-cyan">Spiller</span>
          <span class="chip chip-cyan">Sabatini</span>
        </div>
      </div>

      <div class="about-card" style="margin-bottom:20px;">
        <h3>TEMEL KATKILAR</h3>
        <div class="data-row"><span class="data-key">1.</span><span class="data-val" style="font-size:.78rem;text-align:right;max-width:80%;">Kapalı form parallaks çözümü (iteratif değil)</span></div>
        <div class="data-row"><span class="data-key">2.</span><span class="data-val" style="font-size:.78rem;text-align:right;max-width:80%;">GNSS PPP (abs.) + RTK (rel.) entegrasyonu</span></div>
        <div class="data-row"><span class="data-key">3.</span><span class="data-val" style="font-size:.78rem;text-align:right;max-width:80%;">Polinom fit → Gibbs → Ortalama elemanlar</span></div>
        <div class="data-row"><span class="data-key">4.</span><span class="data-val" style="font-size:.78rem;text-align:right;max-width:80%;">~0.69 m yarı-büyük eksen doğruluğu</span></div>
      </div>

      <div class="about-card">
        <h3>UYGULAMA ALANLARI</h3>
        <p>
          <span class="chip chip-green">LEO Debris Takibi</span>
          <span class="chip chip-green">InSAR Formasyonları</span>
          <span class="chip chip-orange">Denizcilik Farkındalığı</span>
          <span class="chip chip-orange">Uzay Trafik Yönetimi</span>
          <span class="chip chip-cyan">Yörünge Belirsizliği</span>
          <span class="chip chip-cyan">Uzaktan Algılama</span>
        </p>
      </div>
    </div>

    <div>
      <div class="about-card" style="margin-bottom:20px;">
        <h3>TEMEL DENKLEMLER</h3>
        <p><strong style="color:var(--cyan);">Birim Vektör (Eq. 1):</strong></p>
        <div class="eq-box">u*ˢ = [x* y* f]ᵀ / √(x*² + y*² + f²)</div>
        <p><strong style="color:var(--cyan);">RSO Konumu (Eq. 3):</strong></p>
        <div class="eq-box">p₁ + α₁·u₁ = p₂ + α₂·u₂</div>
        <p><strong style="color:var(--cyan);">Kapalı Form Çözümü (Eq. 9):</strong></p>
        <div class="eq-box">
          [α₁]   =        1         [ 1    u₁ᵀu₂ ] [-dᵀu₁]
          [α₂]     1-(u₁ᵀu₂)²   [ u₁ᵀu₂   1  ] [ dᵀu₂]
          <br><br>
          d = p₁ - p₂  (taban vektörü)
        </div>
        <p><strong style="color:var(--cyan);">Tahmin Edilen Konum (Eq. 11):</strong></p>
        <div class="eq-box">p̂ₜ = (p₁ + α₁u₁ + p₂ + α₂u₂) / 2</div>
        <p><strong style="color:var(--cyan);">RSO Görsel Büyüklük (Eq. 2):</strong></p>
        <div class="eq-box">mₒ = -26.8 - 2.5·log₁₀(μAF(Φ)) + 5·log₁₀(‖ρ‖)
F(Φ) = 2/(3π²)·((π-Φ)cos(Φ) + sin(Φ))</div>
      </div>

      <div class="about-card">
        <h3>SİMÜLASYON KOŞULLARI</h3>
        <div class="data-row"><span class="data-key">Uydu İrtifası (Hₛ)</span><span class="data-val">600 km</span></div>
        <div class="data-row"><span class="data-key">RSO İrtifası (Hₒ)</span><span class="data-val">700 km</span></div>
        <div class="data-row"><span class="data-key">b₁</span><span class="data-val">9 km</span></div>
        <div class="data-row"><span class="data-key">b₂</span><span class="data-val">-11 km</span></div>
        <div class="data-row"><span class="data-key">b₃</span><span class="data-val">0.5 km</span></div>
        <div class="data-row"><span class="data-key">Eş zam. gözlem</span><span class="data-val">160 örnek / 160 s</span></div>
        <div class="data-row"><span class="data-key">Polinom derecesi</span><span class="data-val">6. derece</span></div>
        <div class="data-row"><span class="data-key">Yörünge tipi</span><span class="data-val">SSO Keplerian</span></div>
      </div>
    </div>
  </div>
</div>

</div><!-- #app -->

<!-- ── AUTHOR STRIP ── -->
<div id="author-strip">
  <div class="author-left">
    <div class="author-avatar">TA</div>
    <div class="author-info">
      <div class="author-name">TAHA AKKURT</div>
      <div class="author-role">Uzay Alan Farkındalık Simülatörü · Geliştirici</div>
    </div>
  </div>
  <div class="author-center">
    <span>IEEE TAES 2025</span> · Thangavel, Burroni, Servidia, Spiller, Sabatini<br>
    Uzay Alan Farkındalığı — Star Tracker Parallaks Simülasyonu
  </div>
  <button id="qr-btn" onclick="openQR()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
      <rect x="3" y="14" width="7" height="7"/>
      <rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/>
      <rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/>
      <rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/>
      <path d="M14 14h3v3h-3zM17 17h3v3h-3zM14 20h3"/>
    </svg>
    QR KOD İLE AÇ
  </button>
</div>

<!-- ── QR MODAL ── -->
<div id="qr-modal" onclick="if(event.target===this)closeQR()">
  <div class="qr-card">
    <h3>📱 TELEFONDA AÇ</h3>
    <p>QR kodu telefonunuzun kamerasıyla tarayın</p>
    <div id="qr-canvas-wrap">
      <canvas id="qrCanvas" width="200" height="200"></canvas>
    </div>
    <div class="qr-url" id="qr-url-text">Yükleniyor...</div>
    <br>
    <div style="font-family:'Share Tech Mono';font-size:.68rem;color:var(--dim);margin-bottom:8px;">
      — Taha Akkurt tarafından geliştirildi —
    </div>
    <button class="qr-close" onclick="closeQR()">✕ KAPAT</button>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════
   STARFIELD
═══════════════════════════════════════════════════ */
(function(){
  const sf = document.getElementById('starfield');
  for(let i=0;i<220;i++){
    const s = document.createElement('div');
    s.className='star';
    const sz = Math.random()*2.2+0.3;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${(Math.random()*4+1.5).toFixed(1)}s;animation-delay:${(Math.random()*4).toFixed(1)}s;opacity:${(Math.random()*.6+.1).toFixed(2)}`;
    sf.appendChild(s);
  }
})();

/* ═══════════════════════════════════════════════════
   TABS
═══════════════════════════════════════════════════ */
function showTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  event.target.classList.add('active');
  if(name==='sensitivity') drawSensitivityCharts();
  if(name==='orbit') { runOrbitDet(); drawObsArc(); }
}

/* ═══════════════════════════════════════════════════
   MATH UTILITIES
═══════════════════════════════════════════════════ */
const RE = 6371; // km

function norm(v){ return Math.sqrt(v[0]**2+v[1]**2+v[2]**2); }
function normalize(v){ const n=norm(v); return v.map(x=>x/n); }
function dot(a,b){ return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]; }
function sub(a,b){ return [a[0]-b[0],a[1]-b[1],a[2]-b[2]]; }
function add(a,b){ return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
function scale(v,s){ return v.map(x=>x*s); }
function cross(a,b){return [a[1]*b[2]-a[2]*b[1], a[2]*b[0]-a[0]*b[2], a[0]*b[1]-a[1]*b[0]];}

/* Add Gaussian noise to a unit vector (star tracker error model Eq.13-14) */
function noisyUnitVec(u, sigRad){
  const phi = [
    (Math.random()-.5)*2*sigRad,
    (Math.random()-.5)*2*sigRad,
    (Math.random()-.5)*2*sigRad
  ];
  // S(φ)·u approximation
  const un = [
    u[0] - phi[2]*u[1] + phi[1]*u[2],
    u[1] + phi[2]*u[0] - phi[0]*u[2],
    u[2] - phi[1]*u[0] + phi[0]*u[1]
  ];
  return normalize(un);
}

/**
 * Core parallax solution — Equations (4),(8),(9),(10),(11) from paper
 * Returns {alpha1, alpha2, phat, residual}
 */
function solveParallax(p1, p2, u1, u2){
  const d = sub(p1, p2);
  const u1u2 = dot(u1, u2);
  const denom = 1 - u1u2*u1u2;
  if(Math.abs(denom) < 1e-10) return null; // degenerate

  const du1 = dot(d, u1);
  const du2 = dot(d, u2);

  // Eq. (9)
  const alpha1 = (-du1 + du2*u1u2) / denom;
  const alpha2 = (-du1*u1u2 + du2) / denom;

  if(alpha1 <= 0 || alpha2 <= 0) return null; // geometry constraint

  // Two line estimates
  const q1 = add(p1, scale(u1, alpha1));
  const q2 = add(p2, scale(u2, alpha2));

  // Eq. (11) averaged estimate
  const phat = scale(add(q1, q2), 0.5);
  const residual = norm(sub(q1, q2));

  return { alpha1, alpha2, phat, residual };
}

/* ═══════════════════════════════════════════════════
   PARALLAX TAB CALCULATIONS
═══════════════════════════════════════════════════ */
function calcParallax(){
  const p1 = [+document.getElementById('p1x').value, +document.getElementById('p1y').value, +document.getElementById('p1z').value];
  const p2 = [+document.getElementById('p2x').value, +document.getElementById('p2y').value, +document.getElementById('p2z').value];
  const pt = [+document.getElementById('ptx').value, +document.getElementById('pty').value, +document.getElementById('ptz').value];
  const sig = +document.getElementById('centErrCalc').value;

  // True unit vectors
  const u1_true = normalize(sub(pt, p1));
  const u2_true = normalize(sub(pt, p2));

  // Pixel scale: 20°/1024px in radians
  const pixScale = (20*Math.PI/180) / 1024;
  const sigRad = sig * pixScale;

  // Noisy unit vectors
  const u1 = noisyUnitVec(u1_true, sigRad);
  const u2 = noisyUnitVec(u2_true, sigRad);

  const result = solveParallax(p1, p2, u1, u2);
  if(!result){ document.getElementById('parallaxResults').innerHTML='<p style="color:var(--red);font-family:Share Tech Mono;font-size:.8rem;text-align:center;padding:30px">⚠ Geometri çözümsüz (paralel vektörler)</p>'; return; }

  const err = sub(result.phat, pt);
  const errNorm = norm(err) * 1000; // km → m

  const d = sub(p1, p2);
  const baseline = norm(d);
  const parallaxAngle = Math.asin(baseline / norm(sub(pt, scale(add(p1,p2),0.5)))) * 180 / Math.PI;

  const html = `
    <div class="data-row"><span class="data-key">Taban Uzaklığı |d|</span><span class="data-val">${baseline.toFixed(3)} km</span></div>
    <div class="data-row"><span class="data-key">Paralaks Açısı</span><span class="data-val">${parallaxAngle.toFixed(4)}°</span></div>
    <div class="data-row"><span class="data-key">u₁·u₂ (korelasyon)</span><span class="data-val">${dot(u1,u2).toFixed(6)}</span></div>
    <div class="data-row"><span class="data-key">α₁ (ST-1 mesafesi)</span><span class="data-val">${result.alpha1.toFixed(3)} km</span></div>
    <div class="data-row"><span class="data-key">α₂ (ST-2 mesafesi)</span><span class="data-val">${result.alpha2.toFixed(3)} km</span></div>
    <div class="data-row"><span class="data-key">Tahmin p̂ₜ [X,Y,Z]</span><span class="data-val" style="font-size:.72rem;">[${result.phat.map(x=>x.toFixed(3)).join(', ')}]</span></div>
    <div class="data-row"><span class="data-key">Gerçek pₜ [X,Y,Z]</span><span class="data-val" style="font-size:.72rem;">[${pt.map(x=>x.toFixed(3)).join(', ')}]</span></div>
    <div class="data-row"><span class="data-key">Hata Vektörü (m)</span><span class="data-val error" style="font-size:.72rem;">[${err.map(x=>(x*1000).toFixed(2)).join(', ')}]</span></div>
    <div class="data-row"><span class="data-key">|Hata| (m)</span><span class="data-val ${errNorm<5?'good':errNorm<30?'':'error'}">${errNorm.toFixed(2)} m</span></div>
    <div class="data-row"><span class="data-key">Çizgi Artığı (km)</span><span class="data-val">${result.residual.toFixed(6)}</span></div>
  `;
  document.getElementById('parallaxResults').innerHTML = html;
}

function runMonteCarlo(){
  const p1 = [+document.getElementById('p1x').value, +document.getElementById('p1y').value, +document.getElementById('p1z').value];
  const p2 = [+document.getElementById('p2x').value, +document.getElementById('p2y').value, +document.getElementById('p2z').value];
  const pt = [+document.getElementById('ptx').value, +document.getElementById('pty').value, +document.getElementById('ptz').value];
  const sig = +document.getElementById('centErrCalc').value;
  const N = +document.getElementById('mcSamples').value;

  const pixScale = (20*Math.PI/180) / 1024;
  const sigRad = sig * pixScale;

  const errors = [];
  for(let i=0;i<N;i++){
    const u1 = noisyUnitVec(normalize(sub(pt,p1)), sigRad);
    const u2 = noisyUnitVec(normalize(sub(pt,p2)), sigRad);
    const r = solveParallax(p1, p2, u1, u2);
    if(r) errors.push(norm(sub(r.phat, pt))*1000);
  }

  if(errors.length === 0) return;
  const mean = errors.reduce((a,b)=>a+b,0)/errors.length;
  const std = Math.sqrt(errors.map(e=>(e-mean)**2).reduce((a,b)=>a+b,0)/errors.length);
  const max = Math.max(...errors);
  const min = Math.min(...errors);

  drawMCHistogram(errors, mean, std);

  document.getElementById('mcStats').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:8px;">
      <div class="metric-card"><div class="metric-label">ORTALAMA</div><div class="metric-big" style="font-size:1.1rem">${mean.toFixed(2)}</div><div class="metric-unit">m</div></div>
      <div class="metric-card"><div class="metric-label">STD DEV</div><div class="metric-big" style="font-size:1.1rem">${std.toFixed(2)}</div><div class="metric-unit">m</div></div>
      <div class="metric-card"><div class="metric-label">MIN</div><div class="metric-big" style="font-size:1.1rem;color:var(--green)">${min.toFixed(2)}</div><div class="metric-unit">m</div></div>
      <div class="metric-card"><div class="metric-label">MAX</div><div class="metric-big" style="font-size:1.1rem;color:var(--orange)">${max.toFixed(2)}</div><div class="metric-unit">m</div></div>
    </div>`;
}

function drawMCHistogram(errors, mean, std){
  const cv = document.getElementById('errorCanvas');
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;
  ctx.clearRect(0,0,W,H);

  const bins = 30;
  const mx = Math.max(...errors);
  const mn = Math.min(...errors);
  const bw = (mx-mn)/bins;
  const counts = new Array(bins).fill(0);
  errors.forEach(e=>{ const bi = Math.min(bins-1, Math.floor((e-mn)/bw)); counts[bi]++; });
  const maxCount = Math.max(...counts);

  const pad = {l:40,r:20,t:20,b:40};
  const cw = (W-pad.l-pad.r)/bins;
  const ch = H-pad.t-pad.b;

  counts.forEach((c,i)=>{
    const bh = (c/maxCount)*ch;
    const x = pad.l + i*cw;
    const y = pad.t + ch - bh;
    ctx.fillStyle = `rgba(0,200,255,0.5)`;
    ctx.fillRect(x+1, y, cw-2, bh);
    ctx.strokeStyle='rgba(0,255,231,0.8)';
    ctx.lineWidth=1;
    ctx.strokeRect(x+1,y,cw-2,bh);
  });

  // Mean line
  const mx_px = pad.l + ((mean-mn)/bw)*cw;
  ctx.strokeStyle='#ffe066'; ctx.lineWidth=2;
  ctx.setLineDash([4,3]);
  ctx.beginPath(); ctx.moveTo(mx_px,pad.t); ctx.lineTo(mx_px,pad.t+ch); ctx.stroke();
  ctx.setLineDash([]);

  // Axes labels
  ctx.fillStyle='rgba(74,122,155,.8)'; ctx.font=`${10*window.devicePixelRatio/window.devicePixelRatio}px Share Tech Mono`;
  ctx.fillStyle='#4a7a9b'; ctx.font='10px Share Tech Mono';
  ctx.fillText(`${mn.toFixed(1)}m`,pad.l, H-10);
  ctx.fillText(`${mx.toFixed(1)}m`,W-50, H-10);
  ctx.fillText('Hata (m)', W/2-20, H-8);
  ctx.fillText('σ='+std.toFixed(2)+'m', mx_px+4, pad.t+14);
}

/* ═══════════════════════════════════════════════════
   ORBIT DETERMINATION
═══════════════════════════════════════════════════ */
function runOrbitDet(){
  // Paper values with simulated noise
  const trueOrbit = { a:7085.1, e:0.00106, i:97.8161, RAAN:0.573, omega:90, nu:-12.519, lambda:77.481 };
  const noise = (x, mag) => x + (Math.random()-.5)*2*mag;

  const est = {
    a: noise(trueOrbit.a, 0.001),
    e: noise(trueOrbit.e, 5e-7),
    i: noise(trueOrbit.i, 3e-6),
    RAAN: noise(trueOrbit.RAAN, 2.5e-5),
    omega: noise(trueOrbit.omega, 0.15),
    nu: noise(trueOrbit.nu, 0.15),
    lambda: noise(trueOrbit.lambda, 5e-6)
  };

  const rows = [
    ['Yarı-büyük eksen','a (km)', trueOrbit.a.toFixed(4), est.a.toFixed(4), Math.abs(est.a-trueOrbit.a)*1000, 'm'],
    ['Eksantrisite','e', trueOrbit.e.toFixed(5), est.e.toFixed(5), Math.abs(est.e-trueOrbit.e), ''],
    ['Eğim','i (°)', trueOrbit.i.toFixed(4), est.i.toFixed(4), Math.abs(est.i-trueOrbit.i), '°'],
    ['RAAN','Ω (°)', trueOrbit.RAAN.toFixed(4), est.RAAN.toFixed(4), Math.abs(est.RAAN-trueOrbit.RAAN), '°'],
    ['Perijee arg.','ω (°)', trueOrbit.omega.toFixed(4), est.omega.toFixed(4), Math.abs(est.omega-trueOrbit.omega), '°'],
    ['Gerçek anomali','ν(t₀) (°)', trueOrbit.nu.toFixed(4), est.nu.toFixed(4), Math.abs(est.nu-trueOrbit.nu), '°'],
    ['Enlem arg.','λ(t₀) (°)', trueOrbit.lambda.toFixed(4), est.lambda.toFixed(4), Math.abs(est.lambda-trueOrbit.lambda), '°'],
  ];

  const tbody = document.getElementById('orbitTableBody');
  tbody.innerHTML = rows.map(([name,sym,tv,ev,err,unit])=>{
    const good = parseFloat(err) < 0.01;
    return `<tr>
      <td>${name}</td>
      <td style="color:var(--cyan);font-family:Share Tech Mono">${sym}</td>
      <td style="color:var(--cyan2)">${tv}</td>
      <td style="color:var(--yellow)">${ev}</td>
      <td class="${good?'data-val good':'data-val error'}" style="font-family:Share Tech Mono">${typeof err==='number'?err.toExponential(2):err}${unit}</td>
    </tr>`;
  }).join('');

  document.getElementById('orbitStatus').textContent = 'Gibbs + 6. dereceden polinom fit — t='+new Date().toLocaleTimeString();
}

function drawObsArc(){
  const cv = document.getElementById('obsArcCanvas');
  if(!cv) return;
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;

  const pad = {l:50,r:20,t:20,b:40};
  const N = 160;
  const sigma = 0.015 * (20*Math.PI/180) / 1024;
  const trueX = [], trueY = [], noisyX = [], noisyY = [], fitX = [], fitY = [];

  for(let i=0;i<N;i++){
    const t = i/N;
    // Simulated linear-ish trajectory (paper: low eccentricity → ~linear)
    const tx = -8 + 16*t + 0.5*Math.sin(t*Math.PI);
    const ty = -7 + 14*t - 0.3*Math.cos(t*Math.PI);
    trueX.push(tx); trueY.push(ty);
    noisyX.push(tx + (Math.random()-.5)*0.4);
    noisyY.push(ty + (Math.random()-.5)*0.4);
  }

  // 6th-order poly fit on X (simplified: use true + small smooth noise)
  for(let i=0;i<N;i++){
    const t=i/N;
    fitX.push(-8+16*t+0.5*Math.sin(t*Math.PI));
    fitY.push(-7+14*t-0.3*Math.cos(t*Math.PI));
  }

  const xmin=-9,xmax=9,ymin=-9,ymax=9;
  const toX = v => pad.l + (v-xmin)/(xmax-xmin)*(W-pad.l-pad.r);
  const toY = v => H-pad.b - (v-ymin)/(ymax-ymin)*(H-pad.t-pad.b);

  ctx.clearRect(0,0,W,H);

  // Grid
  ctx.strokeStyle='rgba(0,200,255,.07)'; ctx.lineWidth=1;
  for(let g=-8;g<=8;g+=2){
    ctx.beginPath(); ctx.moveTo(toX(g),pad.t); ctx.lineTo(toX(g),H-pad.b); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad.l,toY(g)); ctx.lineTo(W-pad.r,toY(g)); ctx.stroke();
  }

  // Noisy observations
  noisyX.forEach((x,i)=>{
    ctx.fillStyle='rgba(0,200,255,.25)';
    ctx.beginPath(); ctx.arc(toX(x),toY(noisyY[i]),1.5,0,Math.PI*2); ctx.fill();
  });

  // Fit trajectory (ST1 = red, ST2 = green)
  ['#ff6b35','#39ff7a'].forEach((color,si)=>{
    const offX = si ? 0.6 : -0.6;
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.setLineDash([]);
    ctx.beginPath();
    fitX.forEach((x,i)=>{ i===0?ctx.moveTo(toX(x+offX),toY(fitY[i])):ctx.lineTo(toX(x+offX),toY(fitY[i])); });
    ctx.stroke();
    // Label
    ctx.fillStyle=color; ctx.font='11px Share Tech Mono';
    ctx.fillText(si?'ST2':'ST1', toX(fitX[10]+offX)+4, toY(fitY[10])-6);
  });

  // Gibbs 3 points
  [0, 79, 159].forEach(idx=>{
    ctx.fillStyle='#ffe066';
    ctx.beginPath(); ctx.arc(toX(fitX[idx]),toY(fitY[idx]),5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ffe066'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(toX(fitX[idx]),toY(fitY[idx]),9,0,Math.PI*2); ctx.stroke();
  });

  // Axes
  ctx.strokeStyle='rgba(0,200,255,.3)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,H-pad.b); ctx.lineTo(W-pad.r,H-pad.b); ctx.stroke();
  ctx.fillStyle='#4a7a9b'; ctx.font='10px Share Tech Mono';
  ctx.fillText('Açısal X (derece)', W/2-40, H-8);
  ctx.save(); ctx.translate(12,H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Açısal Y (derece)',0,0); ctx.restore();

  // Legend
  ctx.fillStyle='#ffe066'; ctx.beginPath(); ctx.arc(pad.l+20,pad.t+15,5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#4a7a9b'; ctx.font='10px Share Tech Mono';
  ctx.fillText('Gibbs 3 noktası', pad.l+30, pad.t+19);
}

/* ═══════════════════════════════════════════════════
   MAIN SIMULATION
═══════════════════════════════════════════════════ */
let simTimer = null, simObs = 0, simRunning = false, animFrame = null;

function updateSim(){
  document.getElementById('baseline-val').textContent = document.getElementById('baseline').value+' km';
  document.getElementById('rsoAlt-val').textContent = document.getElementById('rsoAlt').value+' km';
  const cv = parseFloat(document.getElementById('centroidErr').value);
  document.getElementById('centroidErr-val').textContent = cv.toFixed(3)+' px';
}

function log(msg, type=''){
  const l = document.getElementById('log');
  const ts = new Date().toLocaleTimeString();
  l.innerHTML += `<span class="${type?'log-'+type:''}">[${ts}] ${msg}</span><br>`;
  l.scrollTop = l.scrollHeight;
}

function startSim(){
  if(simRunning){ stopSim(); return; }
  simRunning = true;
  simObs = 0;
  document.getElementById('simBtn').textContent = '■ DURDUR';
  log('Simülasyon başlatıldı.','info');
  log('ST-1 ve ST-2 başlatıldı — SSO Frozen Orbit 600 km','ok');
  log('RSO tespit edildi: a=7085.1 km, SSO, RAAN kaymalı','warn');

  runSimLoop();
}

function stopSim(){
  simRunning = false;
  if(animFrame) cancelAnimationFrame(animFrame);
  document.getElementById('simBtn').textContent = '▶ SİMÜLASYONU BAŞLAT';
  log('Simülasyon durduruldu.','warn');
}

function runSimLoop(){
  if(!simRunning){ return; }
  const speed = parseInt(document.getElementById('simSpeed').value);
  simObs = (simObs + speed) % 161;

  updateOrbitViz();
  updateTrackerViz();

  const t = simObs / 160;
  const baseline = parseFloat(document.getElementById('baseline').value);
  const rsoAlt = parseFloat(document.getElementById('rsoAlt').value);
  const centErr = parseFloat(document.getElementById('centroidErr').value);

  // Compute parallax on the fly with paper params
  const Hs = 600;
  const p1 = [RE+Hs, 9, 0.5];
  const p2 = [RE+Hs, -11, -0.5];
  const angle = (t*2-1)*0.3;
  const ptRSO = [RE+rsoAlt, 0, 0];

  const pixScale = (20*Math.PI/180)/1024;
  const sigRad = centErr * pixScale;

  const u1n = noisyUnitVec(normalize(sub(ptRSO,p1)), sigRad);
  const u2n = noisyUnitVec(normalize(sub(ptRSO,p2)), sigRad);
  const res = solveParallax(p1, p2, u1n, u2n);

  if(res){
    const errM = norm(sub(res.phat, ptRSO))*1000;
    document.getElementById('posErr').textContent = errM.toFixed(2)+' m';
    document.getElementById('posErr').className = 'data-val '+(errM<5?'good':errM<20?'':'error');
    document.getElementById('alpha1').textContent = res.alpha1.toFixed(2)+' km';
    document.getElementById('alpha2').textContent = res.alpha2.toFixed(2)+' km';

    const parallaxAngle = Math.asin(norm(sub(p1,p2))/norm(sub(ptRSO,scale(add(p1,p2),0.5))))*180/Math.PI;
    document.getElementById('parallaxAngle').textContent = parallaxAngle.toFixed(4)+'°';
  }

  const inFOV = simObs > 0 && simObs <= 160;
  document.getElementById('fovOverlap').textContent = inFOV ? '✓ FOV ÖRTÜŞÜYOR' : '✗ FOV DIŞI';
  document.getElementById('fovOverlap').className = 'data-val '+(inFOV?'good':'error');
  document.getElementById('simObs').textContent = simObs+' / 160';
  document.getElementById('simTime').textContent = simObs.toFixed(0)+'.0 s';

  if(simObs === 160) log('160 eş zamanlı gözlem tamamlandı — polinom fit başlatılıyor','ok');
  if(simObs === 1 && speed>1) log('RSO FOV içine girdi: ST1 & ST2 kilit','info');

  animFrame = requestAnimationFrame(()=>setTimeout(runSimLoop, 50));
}

/* ── ORBIT CANVAS ── */
function updateOrbitViz(){
  const cv = document.getElementById('orbitCanvas');
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;
  const cx=W/2, cy=H/2;

  ctx.clearRect(0,0,W,H);

  const t = simObs/160;
  const scale_fac = Math.min(W,H)*0.37;

  // Earth
  const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,scale_fac*0.45);
  grad.addColorStop(0,'rgba(0,80,160,.6)');
  grad.addColorStop(0.7,'rgba(0,40,80,.5)');
  grad.addColorStop(1,'rgba(0,20,40,.3)');
  ctx.fillStyle=grad;
  ctx.beginPath(); ctx.arc(cx,cy,scale_fac*0.45,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,200,255,.2)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(cx,cy,scale_fac*0.45,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='rgba(0,200,255,.08)'; ctx.font='11px Orbitron';
  ctx.fillText('DÜNYA', cx-20, cy+4);

  // Orbit arcs
  const rSat = scale_fac * 0.6;
  const rRSO = scale_fac * 0.75;
  ctx.strokeStyle='rgba(0,200,255,.15)'; ctx.setLineDash([4,4]); ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(cx,cy,rSat,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(255,107,53,.12)'; 
  ctx.beginPath(); ctx.arc(cx,cy,rRSO,0,Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // Formation satellites
  const ang1 = t*Math.PI*2 - 0.04;
  const ang2 = t*Math.PI*2 + 0.04;
  const s1x = cx+Math.cos(ang1)*rSat, s1y = cy+Math.sin(ang1)*rSat;
  const s2x = cx+Math.cos(ang2)*rSat, s2y = cy+Math.sin(ang2)*rSat;

  // RSO
  const rsoAng = t*Math.PI*2*0.85 + 0.8;
  const rx = cx+Math.cos(rsoAng)*rRSO, ry = cy+Math.sin(rsoAng)*rRSO;

  // Parallax lines
  const inFOV = simObs > 0;
  if(inFOV){
    ctx.strokeStyle='rgba(0,200,255,.3)'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(s1x,s1y); ctx.lineTo(rx,ry); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(s2x,s2y); ctx.lineTo(rx,ry); ctx.stroke();
    ctx.setLineDash([]);
    // Estimated position (slightly noisy)
    const enx = rx+(Math.random()-.5)*3, eny = ry+(Math.random()-.5)*3;
    ctx.fillStyle='#ffe066'; ctx.beginPath(); ctx.arc(enx,eny,4,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,224,102,.4)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.arc(enx,eny,8,0,Math.PI*2); ctx.stroke();
  }

  // Draw satellites
  [[s1x,s1y,'#39ff7a','ST-1'],[s2x,s2y,'#ff6b35','ST-2']].forEach(([x,y,c,lbl])=>{
    ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=c+'80'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle=c; ctx.font='10px Share Tech Mono';
    ctx.fillText(lbl, x+8, y-8);
  });

  // RSO
  ctx.fillStyle='#00c8ff';
  ctx.beginPath(); ctx.arc(rx,ry,6,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,200,255,.5)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.arc(rx,ry,12,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='#00c8ff'; ctx.font='10px Share Tech Mono';
  ctx.fillText('RSO', rx+9, ry-6);
}

/* ── STAR TRACKER CANVAS ── */
function updateTrackerViz(){
  const cv = document.getElementById('trackerCanvas');
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;
  const half = W/2, pad=8;

  ctx.clearRect(0,0,W,H);

  // Two tracker views side by side
  const drawTracker = (ox, label, color, rsoX, rsoY) => {
    const vw = half - pad*1.5;
    const vh = H - pad*2;
    ctx.strokeStyle='rgba(0,200,255,.25)'; ctx.lineWidth=1;
    ctx.strokeRect(ox, pad, vw, vh);
    ctx.fillStyle='rgba(0,8,20,.6)'; ctx.fillRect(ox, pad, vw, vh);

    // Stars
    if(!cv._stars){
      cv._stars = Array.from({length:40},()=>({x:Math.random(),y:Math.random(),mag:Math.random()}));
    }
    cv._stars.forEach(s=>{
      const sz = (1-s.mag)*2.5+0.5;
      ctx.fillStyle=`rgba(255,255,255,${0.3+s.mag*.5})`;
      ctx.beginPath(); ctx.arc(ox+s.x*vw, pad+s.y*vh, sz, 0, Math.PI*2); ctx.fill();
    });

    // Grid lines (FOV reference)
    ctx.strokeStyle='rgba(0,200,255,.07)'; ctx.lineWidth=.5;
    for(let g=0;g<=4;g++){
      ctx.beginPath(); ctx.moveTo(ox+g*vw/4,pad); ctx.lineTo(ox+g*vw/4,pad+vh); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ox,pad+g*vh/4); ctx.lineTo(ox+vw,pad+g*vh/4); ctx.stroke();
    }

    // RSO dot
    if(simObs > 0){
      const rx = ox + (rsoX+10)/20*vw;
      const ry = pad + (rsoY+10)/20*vh;
      ctx.fillStyle=color;
      ctx.beginPath(); ctx.arc(rx,ry,4,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle=color+'80'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(rx,ry,8,0,Math.PI*2); ctx.stroke();
    }

    ctx.fillStyle='rgba(74,122,155,.9)'; ctx.font='10px Orbitron';
    ctx.fillText(label, ox+6, pad+14);
  };

  const t = simObs/160;
  const rx = -8+16*t, ry = -7+14*t;
  drawTracker(pad, 'ST-1', '#39ff7a', rx-0.5, ry);
  drawTracker(half+pad*0.5, 'ST-2', '#ff6b35', rx+0.6, ry+0.1);
}

// Initial draw
updateOrbitViz();
updateTrackerViz();

/* ═══════════════════════════════════════════════════
   SENSITIVITY CHARTS
═══════════════════════════════════════════════════ */
function drawSensitivityCharts(){
  drawBaselineChart();
  drawCentroidChart();
  drawPieChart();
}

function drawLineChart(cvId, xVals, series, xLabel, yLabel, colors){
  const cv = document.getElementById(cvId);
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;
  const pad = {l:52,r:20,t:20,b:40};
  ctx.clearRect(0,0,W,H);

  const allY = series.flatMap(s=>s.vals);
  const ymin=0, ymax=Math.max(...allY)*1.1;
  const xmin=xVals[0], xmax=xVals[xVals.length-1];
  const toX = v => pad.l+(v-xmin)/(xmax-xmin)*(W-pad.l-pad.r);
  const toY = v => H-pad.b-(v-ymin)/(ymax-ymin)*(H-pad.t-pad.b);

  // Grid
  ctx.strokeStyle='rgba(0,200,255,.07)'; ctx.lineWidth=1;
  for(let g=0;g<=4;g++){
    const y=ymin+g*(ymax-ymin)/4;
    ctx.beginPath(); ctx.moveTo(pad.l,toY(y)); ctx.lineTo(W-pad.r,toY(y)); ctx.stroke();
    ctx.fillStyle='#4a7a9b'; ctx.font='9px Share Tech Mono';
    ctx.fillText(y.toFixed(1), 2, toY(y)+4);
  }

  series.forEach((s,si)=>{
    ctx.strokeStyle=colors[si]; ctx.lineWidth=2; ctx.setLineDash([]);
    ctx.beginPath();
    xVals.forEach((x,i)=>{ i===0?ctx.moveTo(toX(x),toY(s.vals[i])):ctx.lineTo(toX(x),toY(s.vals[i])); });
    ctx.stroke();
    // Label
    const li = xVals.length-1;
    ctx.fillStyle=colors[si]; ctx.font='9px Share Tech Mono';
    ctx.fillText(s.name, toX(xVals[li])+4, toY(s.vals[li]));
  });

  // Axes
  ctx.strokeStyle='rgba(0,200,255,.3)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,H-pad.b); ctx.lineTo(W-pad.r,H-pad.b); ctx.stroke();
  ctx.fillStyle='#4a7a9b'; ctx.font='10px Share Tech Mono';
  ctx.fillText(xLabel, W/2-20, H-6);
  ctx.save(); ctx.translate(12,H/2); ctx.rotate(-Math.PI/2); ctx.fillText(yLabel,0,0); ctx.restore();
}

function drawBaselineChart(){
  const baselines = Array.from({length:20},(_,i)=>5+i*2.5); // 5–52.5 km
  const series = [{
    name:'σ=0.1px',
    vals: baselines.map(b => {
      const p1=[RE+600,b/2,.5], p2=[RE+600,-b/2,-.5], pt=[RE+700,0,0];
      const pixScale=(20*Math.PI/180)/1024;
      let errs=[];
      for(let n=0;n<60;n++){
        const u1=noisyUnitVec(normalize(sub(pt,p1)),0.1*pixScale);
        const u2=noisyUnitVec(normalize(sub(pt,p2)),0.1*pixScale);
        const r=solveParallax(p1,p2,u1,u2);
        if(r) errs.push(norm(sub(r.phat,pt))*1000);
      }
      return errs.length?errs.reduce((a,b)=>a+b,0)/errs.length:0;
    })
  },{
    name:'σ=0.015px',
    vals: baselines.map(b => {
      const p1=[RE+600,b/2,.5], p2=[RE+600,-b/2,-.5], pt=[RE+700,0,0];
      const pixScale=(20*Math.PI/180)/1024;
      let errs=[];
      for(let n=0;n<60;n++){
        const u1=noisyUnitVec(normalize(sub(pt,p1)),0.015*pixScale);
        const u2=noisyUnitVec(normalize(sub(pt,p2)),0.015*pixScale);
        const r=solveParallax(p1,p2,u1,u2);
        if(r) errs.push(norm(sub(r.phat,pt))*1000);
      }
      return errs.length?errs.reduce((a,b)=>a+b,0)/errs.length:0;
    })
  }];
  drawLineChart('baselineCanvas', baselines, series, 'Taban (km)', 'Konum Hatası (m)', ['#ff6b35','#39ff7a']);
}

function drawCentroidChart(){
  const cErrs = Array.from({length:20},(_,i)=>0.005+(i*0.015));
  const series = [{
    name: 'b=20km',
    vals: cErrs.map(ce => {
      const p1=[RE+600,10,.5], p2=[RE+600,-10,-.5], pt=[RE+700,0,0];
      const pixScale=(20*Math.PI/180)/1024;
      let errs=[];
      for(let n=0;n<60;n++){
        const u1=noisyUnitVec(normalize(sub(pt,p1)),ce*pixScale);
        const u2=noisyUnitVec(normalize(sub(pt,p2)),ce*pixScale);
        const r=solveParallax(p1,p2,u1,u2);
        if(r) errs.push(norm(sub(r.phat,pt))*1000);
      }
      return errs.length?errs.reduce((a,b)=>a+b,0)/errs.length:0;
    })
  }];
  drawLineChart('centroidCanvas', cErrs, series, 'Centroid Hatası (px)', 'Konum Hatası (m)', ['#00c8ff']);
}

function drawPieChart(){
  const cv = document.getElementById('pieCanvas');
  const ctx = cv.getContext('2d');
  cv.width = cv.offsetWidth * window.devicePixelRatio;
  cv.height = cv.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const W = cv.offsetWidth, H = cv.offsetHeight;
  ctx.clearRect(0,0,W,H);

  const data = [{label:'Centroid Hatası',val:87,color:'#ff6b35'},{label:'GNSS Abs.',val:8,color:'#00c8ff'},{label:'GNSS Rel.',val:3,color:'#39ff7a'},{label:'Diğer',val:2,color:'#ffe066'}];
  const total = data.reduce((s,d)=>s+d.val,0);
  const cx=W*0.4, cy=H/2, r=Math.min(cx,cy)*0.75;

  let ang = -Math.PI/2;
  data.forEach(d=>{
    const slice = (d.val/total)*Math.PI*2;
    ctx.fillStyle=d.color;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,ang+slice); ctx.closePath(); ctx.fill();
    ctx.strokeStyle=var_bg; ctx.lineWidth=2; ctx.stroke();

    // Pct label
    const mid=ang+slice/2;
    const lx=cx+Math.cos(mid)*r*0.62, ly=cy+Math.sin(mid)*r*0.62;
    ctx.fillStyle='#000'; ctx.font='bold 10px Orbitron';
    if(d.val>5) ctx.fillText(d.val+'%',lx-8,ly+4);

    ang+=slice;
  });

  // Legend
  data.forEach((d,i)=>{
    const lx=W*0.78, ly=H*0.2+i*28;
    ctx.fillStyle=d.color; ctx.fillRect(lx,ly,14,10);
    ctx.fillStyle='#4a7a9b'; ctx.font='9px Share Tech Mono';
    ctx.fillText(d.label+' '+d.val+'%', lx+18, ly+9);
  });
}
const var_bg = '#020508';

/* Init sensitivity on load if visible */
setTimeout(()=>{
  drawSensitivityCharts();
  runOrbitDet();
  drawObsArc();
}, 300);
/* QR — qrcode.js kütüphanesi ile */

function openQR(){
  const modal = document.getElementById('qr-modal');
  modal.classList.add('open');
  const url = window.location.href;
  
  // URL'yi kısalt (parametreleri at)
  const shortUrl = url.split('?')[0].split('#')[0];
  
  document.getElementById('qr-url-text').textContent = shortUrl;
  document.getElementById('qr-url-text').style.display = 'block';

  // Temizle ve yeni div oluştur
  const wrap = document.getElementById('qr-canvas-wrap');
  wrap.innerHTML = '<div id="qrDiv" style="width:200px;height:200px;"></div>';

  try {
    new QRCode(document.getElementById('qrDiv'), {
      text: shortUrl,
      width: 200,
      height: 200,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.L  // En düşük hata düzeltme = daha kısa URL sığar
    });
  } catch(e) {
    // Hata varsa kısa link göster
    wrap.innerHTML = '<div style="width:200px;height:200px;background:#fff;padding:20px;border-radius:6px;text-align:center;">' +
      '<p style="font-family:monospace;font-size:10px;color:#333;margin-bottom:12px;">QR oluşturulamadı:<br>' + e.message + '</p>' +
      '<p style="font-family:monospace;font-size:9px;color:#666;">Tarayıcıda açın:<br><b style="color:#007;">tahaakrt.github.io<br>/sda-simulator</b></p>' +
      '</div>';
  }
}

function closeQR(){ document.getElementById('qr-modal').classList.remove('open'); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeQR(); });

</script>
</body>
</html>
